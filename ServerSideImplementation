// Program.cs (ASP.NET Core minimal API)
// NuGet packages required:
// - Microsoft.AspNetCore.Authentication.Cookies
// - MySqlConnector
// - BCrypt.Net-Next

using System.ComponentModel.DataAnnotations;
using System.Security.Claims;
using System.Text.Encodings.Web;
using System.Text.RegularExpressions;
using BCrypt.Net;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Antiforgery;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.DependencyInjection;
using MySqlConnector;

var builder = WebApplication.CreateBuilder(args);

// Authentication and Authorization
builder.Services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
    .AddCookie(options =>
    {
        options.LoginPath = "/login";
        options.Cookie.HttpOnly = true;
        options.Cookie.SecurePolicy = CookieSecurePolicy.Always;
        options.Cookie.SameSite = SameSiteMode.Strict;
    });

builder.Services.AddAuthorization(options =>
{
    options.AddPolicy("AdminOnly", policy => policy.RequireRole("Admin"));
});

builder.Services.AddAntiforgery(options => { options.HeaderName = "X-CSRF-TOKEN"; });
builder.Services.AddRouting();

var app = builder.Build();

string connectionString = builder.Configuration.GetConnectionString("DefaultConnection")
                          ?? "Server=localhost;Database=appdb;User=root;Password=secret;";

// Serve form with CSRF token
app.MapGet("/form", async (HttpContext http, IAntiforgery antiforgery) =>
{
    var tokens = antiforgery.GetAndStoreTokens(http);
    var html = System.IO.File.ReadAllText("webform.html").Replace("{{CSRF_TOKEN_HERE}}", tokens.RequestToken);
    http.Response.ContentType = "text/html; charset=utf-8";
    await http.Response.WriteAsync(html);
});

// Registration endpoint
app.MapPost("/register", async (HttpContext http, IAntiforgery antiforgery) =>
{
    try { await antiforgery.ValidateRequestAsync(http); } catch { http.Response.StatusCode = 400; await http.Response.WriteAsync("Invalid CSRF token."); return; }

    var form = await http.Request.ReadFormAsync();
    var username = form["username"].ToString();
    var email = form["email"].ToString();
    var password = form["password"].ToString();

    var input = new RegisterInput { Username = username, Email = email, Password = password };
    var validationResults = new List<ValidationResult>();
    if (!Validator.TryValidateObject(input, new ValidationContext(input), validationResults, true))
    {
        http.Response.StatusCode = 400;
        await http.Response.WriteAsync(string.Join("; ", validationResults.Select(r => r.ErrorMessage)));
        return;
    }

    username = SanitizeUsername(username);
    email = NormalizeEmail(email);

    // Hash password with bcrypt
    var passwordHash = BCrypt.Net.BCrypt.HashPassword(password, workFactor: 12);

    using var conn = new MySqlConnection(connectionString);
    await conn.OpenAsync();
    using var cmd = conn.CreateCommand();
    cmd.CommandText = "INSERT INTO Users (Username, Email, PasswordHash, Role) VALUES (@username, @email, @passwordHash, @role)";
    cmd.Parameters.AddWithValue("@username", username);
    cmd.Parameters.AddWithValue("@email", email);
    cmd.Parameters.AddWithValue("@passwordHash", passwordHash);
    cmd.Parameters.AddWithValue("@role", "User"); // default role

    try
    {
        await cmd.ExecuteNonQueryAsync();
    }
    catch (MySqlException ex) when (ex.Number == 1062)
    {
        http.Response.StatusCode = 409;
        await http.Response.WriteAsync("Email already registered.");
        return;
    }
    catch
    {
        http.Response.StatusCode = 500;
        await http.Response.WriteAsync("Database error.");
        return;
    }

    http.Response.StatusCode = 201;
    await http.Response.WriteAsync("Registered.");
});

// Login endpoint
app.MapPost("/login", async (HttpContext http, IAntiforgery antiforgery) =>
{
    try { await antiforgery.ValidateRequestAsync(http); } catch { http.Response.StatusCode = 400; await http.Response.WriteAsync("Invalid CSRF token."); return; }

    var form = await http.Request.ReadFormAsync();
    var email = NormalizeEmail(form["email"]);
    var password = form["password"].ToString();

    if (string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(password))
    {
        http.Response.StatusCode = 400;
        await http.Response.WriteAsync("Missing credentials.");
        return;
    }

    using var conn = new MySqlConnection(connectionString);
    await conn.OpenAsync();
    using var cmd = conn.CreateCommand();
    cmd.CommandText = "SELECT UserID, Username, PasswordHash, Role FROM Users WHERE Email = @email LIMIT 1";
    cmd.Parameters.AddWithValue("@email", email);

    using var reader = await cmd.ExecuteReaderAsync();
    if (!await reader.ReadAsync())
    {
        // Do not reveal whether email exists
        http.Response.StatusCode = 401;
        await http.Response.WriteAsync("Invalid credentials.");
        return;
    }

    var userId = reader.GetInt32("UserID");
    var username = reader.GetString("Username");
    var passwordHash = reader.GetString("PasswordHash");
    var role = reader.GetString("Role");

    // Verify password using bcrypt
    var verified = BCrypt.Net.BCrypt.Verify(password, passwordHash);
    if (!verified)
    {
        http.Response.StatusCode = 401;
        await http.Response.WriteAsync("Invalid credentials.");
        return;
    }

    // Create claims and sign in
    var claims = new List<Claim>
    {
        new Claim(ClaimTypes.NameIdentifier, userId.ToString()),
        new Claim(ClaimTypes.Name, username),
        new Claim(ClaimTypes.Email, email),
        new Claim(ClaimTypes.Role, role)
    };
    var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
    var principal = new ClaimsPrincipal(identity);
    await http.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, principal);

    http.Response.StatusCode = 200;
    await http.Response.WriteAsync("Logged in.");
});

// Logout
app.MapPost("/logout", async (HttpContext http) =>
{
    await http.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
    http.Response.StatusCode = 200;
    await http.Response.WriteAsync("Logged out.");
});

// Protected admin route
app.MapGet("/admin", [Authorize(Policy = "AdminOnly")] async (HttpContext http) =>
{
    await http.Response.WriteAsync("Welcome to admin tools.");
});

// Example protected user route
app.MapGet("/profile", [Authorize] async (HttpContext http) =>
{
    var name = http.User.Identity?.Name ?? "unknown";
    await http.Response.WriteAsync($"Hello {name}");
});

app.UseAuthentication();
app.UseAuthorization();

app.Run();

static string SanitizeUsername(string input)
{
    if (string.IsNullOrWhiteSpace(input)) return string.Empty;
    input = input.Trim();
    input = Regex.Replace(input, @"\p{C}+", string.Empty);
    input = Regex.Replace(input, @"[^A-Za-z0-9_\-\. ]+", string.Empty);
    if (input.Length > 100) input = input.Substring(0, 100);
    return input;
}

static string NormalizeEmail(string email)
{
    if (string.IsNullOrWhiteSpace(email)) return string.Empty;
    email = email.Trim().ToLowerInvariant();
    if (email.Length > 255) email = email.Substring(0, 255);
    return email;
}

public class RegisterInput
{
    [Required]
    [StringLength(100, MinimumLength = 1)]
    public string Username { get; set; }

    [Required]
    [EmailAddress]
    [StringLength(255)]
    public string Email { get; set; }

    [Required]
    [StringLength(128, MinimumLength = 8)]
    public string Password { get; set; }
}
